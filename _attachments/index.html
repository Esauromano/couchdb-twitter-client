<!DOCTYPE html>
<html>
  <head>
    <title>CouchDB Twitter Client</title>
    <link rel="stylesheet" href="reset.css" type="text/css">
    <link rel="stylesheet" href="screen.css" type="text/css">
  </head>
  <body>
    <div id="tweets"> 
      <ul></ul> 
    </div>    
  </body>
  <script src="/_utils/script/json2.js"></script>
  <script src="/_utils/script/jquery.js?1.2.6"></script>
  <script src="/_utils/script/jquery.couch.js?0.8.0"></script>

  <script src="user.js"></script>
  <script src="twitter-couch.js"></script>
  <script type="text/javascript" charset="utf-8">
    $(function() {
      // DB.view(design+"/example",{success: function(json) {
      //   $("#view").html(json.rows.map(function(row) {
      //     return '<li>'+row.key+'</li>';
      //   }).join(''));
      // }});
      
      function renderTimeline(tweets) {
        $.each(tweets, function(i, tweet) { 
          // todo map
          $("#tweets ul").append('<li><img class="profile" src="'+tweet.user.profile_image_url+'" />'
            + '<h3><a class="user" title="'
            + tweet.user.screen_name + '" href="http://twitter.com/'
            + tweet.user.screen_name + '">'
            + tweet.user.name
            +'</a></h3>'
            + tweet.text  
            + ' <span class="created_at">'
            // + relative_time(tweet.created_at)  
            + ' via '
            + tweet.source  
            + '</span><br class="clear"/></li>'); 
        });        
      };
      
      var db = $.couch.db(document.location.href.split('/')[3]);
      var design = new CouchDesign(db, unescape(document.location.href).split('/')[5]);
      
      TwitterCouch(db, design, function(tw) {
        tw.friendsTimeline(function(tweets) {
          renderTimeline(tweets);
        });
      });
      
    });
  </script>
</html>